@(registerForm: Form[forms.RegisterForm])(implicit request: Http.Request, messages: play.i18n.Messages)
@import utils.GlobalConfigHelper
@import helper._

@implicitField: FieldConstructor = @{ FieldConstructor(tags.forms.field_constructor.render) }

@defining(GlobalConfigHelper.getLegalLinksConfiguration(request)) { legalLinks =>

@authLayout {

  @request.flash.asScala().get("success").map { successFlashValue =>
    <div class="alert alert-success" role="alert">
      @successFlashValue
    </div>
  }

  @request.flash.asScala().get("error").map { errorFlashValue =>
    <div class="alert alert-danger" role="alert">
      @errorFlashValue
    </div>
  }

  <div class="register-box">
    <div class="register-logo">
      <b>@messages("app.title")</b>
    </div>
    
    <div class="card">
      <div class="card-body register-card-body">
        <p class="login-box-msg">@messages("auth.register.subtitle")</p>
          
          @form(action = routes.AuthController.register()) {
            
            @if(registerForm.hasGlobalErrors) {
              <div class="alert alert-danger">
                @for(error <- registerForm.globalErrors) {
                  @error.message
                }
              </div>
            }
            
            @CSRF.formField
            
            <div class="input-group mb-3">
              <input type="text" class="form-control @if(registerForm("username").hasErrors){is-invalid}" 
                     name="@registerForm("username").name" 
                     value="@registerForm("username").value.getOrElse("")"
                     placeholder="@messages("auth.username")">
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-user"></span>
                </div>
              </div>
              @if(registerForm("username").hasErrors) {
                <div class="invalid-feedback">
                  @registerForm("username").errors.mkString(", ")
                </div>
              }
            </div>
            
            <div class="input-group mb-3">
              <input type="email" class="form-control @if(registerForm("email").hasErrors){is-invalid}" 
                     name="@registerForm("email").name" 
                     value="@registerForm("email").value.getOrElse("")"
                     placeholder="@messages("auth.email")">
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-envelope"></span>
                </div>
              </div>
              @if(registerForm("email").hasErrors) {
                <div class="invalid-feedback">
                  @registerForm("email").errors.mkString(", ")
                </div>
              }
            </div>
            
            <div class="input-group mb-3">
              <input type="password" class="form-control @if(registerForm("password").hasErrors){is-invalid}" 
                     name="@registerForm("password").name" 
                     id="password"
                     placeholder="@messages("auth.password")">
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
              @if(registerForm("password").hasErrors) {
                <div class="invalid-feedback">
                  @registerForm("password").errors.mkString(", ")
                </div>
              }
            </div>
            
            <div id="password-strength-container" style="display: none;" class="mb-3">
              <div class="password-strength-meter">
                <div class="progress" style="height: 8px;">
                  <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                </div>
                <small id="password-strength-text" class="form-text text-muted"></small>
              </div>
            </div>
            
            <div class="input-group mb-3">
              <input type="password" class="form-control @if(registerForm("confirmPassword").hasErrors){is-invalid}" 
                     name="@registerForm("confirmPassword").name"
                     placeholder="@messages("auth.confirm.password")">
              <div class="input-group-append">
                <div class="input-group-text">
                  <span class="fas fa-lock"></span>
                </div>
              </div>
              @if(registerForm("confirmPassword").hasErrors) {
                <div class="invalid-feedback">
                  @registerForm("confirmPassword").errors.mkString(", ")
                </div>
              }
            </div>
            
            @if(legalLinks.hasTermsOfServiceUrl()) {
              <div class="form-group mb-3">
                <div class="icheck-primary">
                  <input type="checkbox" value="true" id="agreeToTerms" name="agreeToTerms" 
                         class="@if(registerForm("agreeToTerms").hasErrors) {is-invalid}" 
                         @if(registerForm("agreeToTerms").value.orElse("false").equals("true")) {checked}>
                  <label for="agreeToTerms">
                    <a href="@legalLinks.getTermsOfServiceUrl().get()" target="_blank">@messages("footer.terms")</a>に同意する
                  </label>
                  @if(registerForm("agreeToTerms").hasErrors) {
                    <div class="invalid-feedback d-block">
                      @registerForm("agreeToTerms").errors.asScala.map(_.message).mkString(", ")
                    </div>
                  }
                </div>
              </div>
            }
            
            <div class="row">
              <div class="col-12">
                <button type="submit" class="btn btn-primary btn-block">
                  <i class="fas fa-user-plus mr-2"></i>@messages("auth.register.button")
                </button>
              </div>
            </div>
          }
          
          <div class="mt-3 text-center">
            <a href="@routes.AuthController.showLogin()">@messages("auth.have.account.login")</a>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Password strength validation -->
  <script src="@routes.Assets.versioned("lib/zxcvbn/dist/zxcvbn.js")"></script>
  <script>
    (function() {
      'use strict';
      
      const passwordInput = document.getElementById('password');
      const strengthContainer = document.getElementById('password-strength-container');
      const strengthBar = document.getElementById('password-strength-bar');
      const strengthText = document.getElementById('password-strength-text');
      const submitButton = document.querySelector('button[type="submit"]');
      
      if (!passwordInput || !strengthContainer) return;
      
      // Get localized strength labels from server
      const strengthLabels = {
        0: { text: '@messages("validation.password.strength.veryweak")', color: 'bg-danger', class: 'text-danger' },
        1: { text: '@messages("validation.password.strength.weak")', color: 'bg-warning', class: 'text-warning' },
        2: { text: '@messages("validation.password.strength.fair")', color: 'bg-info', class: 'text-info' },
        3: { text: '@messages("validation.password.strength.strong")', color: 'bg-success', class: 'text-success' },
        4: { text: '@messages("validation.password.strength.verystrong")', color: 'bg-success', class: 'text-success' }
      };
      
      const messages = {
        loading: '@Html(messages("validation.password.strength.loading").replace("'", "\\'"))',
        warning: '@Html(messages("validation.password.strength.warning").replace("'", "\\'"))',
        success: '@Html(messages("validation.password.strength.success").replace("'", "\\'"))',
        hint: '@Html(messages("validation.password.strength.hint").replace("'", "\\'"))'
      };
      
      function updatePasswordStrength() {
        const password = passwordInput.value;
        
        if (password.length === 0) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        
        if (typeof zxcvbn === 'undefined') {
          strengthText.textContent = messages.loading;
          return;
        }
        
        const result = zxcvbn(password);
        const score = result.score;
        const strength = strengthLabels[score];
        
        // Update progress bar
        strengthBar.className = 'progress-bar ' + strength.color;
        strengthBar.style.width = ((score + 1) * 20) + '%';
        
        // Update text
        strengthText.className = 'form-text ' + strength.class;
        
        if (score < 2) {
          strengthText.textContent = messages.warning.replace('{0}', strength.text);
          if (submitButton) {
            submitButton.disabled = true;
          }
        } else {
          strengthText.textContent = messages.success.replace('{0}', strength.text);
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
        
        // Show suggestions if available
        if (result.feedback && result.feedback.suggestions && result.feedback.suggestions.length > 0) {
          const suggestions = result.feedback.suggestions.join(' ');
          strengthText.textContent += messages.hint.replace('{0}', suggestions);
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        if (passwordInput.value) {
          updatePasswordStrength();
        }
      });
      
      // Update on input
      passwordInput.addEventListener('input', updatePasswordStrength);
      passwordInput.addEventListener('keyup', updatePasswordStrength);
    })();
  </script>

}
}