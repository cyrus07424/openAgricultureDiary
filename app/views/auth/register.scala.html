@(registerForm: Form[forms.RegisterForm])(implicit request: Http.Request, messages: play.i18n.Messages)
@import utils.GlobalConfigHelper
@import helper._

@implicitField: FieldConstructor = @{ FieldConstructor(tags.forms.field_constructor.render) }

@defining(GlobalConfigHelper.getLegalLinksConfiguration(request)) { legalLinks =>

@authLayout {

  @request.flash.asScala().get("success").map { successFlashValue =>
    <div class="alert alert-success" role="alert">
      @successFlashValue
    </div>
  }

  @request.flash.asScala().get("error").map { errorFlashValue =>
    <div class="alert alert-danger" role="alert">
      @errorFlashValue
    </div>
  }

  <div class="row">
    <div class="col-md-6 offset-md-3">
      <div class="card mt-5">
        <div class="card-header">
          <h3>@messages("auth.register")</h3>
        </div>
        <div class="card-body">
          
          @form(action = routes.AuthController.register()) {
            
            @if(registerForm.hasGlobalErrors) {
              <div class="alert alert-danger">
                @for(error <- registerForm.globalErrors) {
                  @error.message
                }
              </div>
            }
            
            @CSRF.formField
            
            <div class="form-group mb-3">
              @inputText(registerForm("username"), Symbol("_label") -> messages("auth.username"), Symbol("class") -> "form-control")
            </div>
            
            <div class="form-group mb-3">
              @inputText(registerForm("email"), Symbol("_label") -> messages("auth.email"), Symbol("class") -> "form-control", Symbol("_type") -> "email")
            </div>
            
            <div class="form-group mb-3">
              @inputPassword(registerForm("password"), Symbol("_label") -> messages("auth.password"), Symbol("class") -> "form-control", Symbol("id") -> "password")
              <div id="password-strength-container" style="display: none;">
                <div class="password-strength-meter mt-2">
                  <div class="progress" style="height: 8px;">
                    <div id="password-strength-bar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
                  </div>
                  <small id="password-strength-text" class="form-text text-muted"></small>
                </div>
              </div>
            </div>
            
            <div class="form-group mb-3">
              @inputPassword(registerForm("confirmPassword"), Symbol("_label") -> messages("auth.confirm.password"), Symbol("class") -> "form-control")
            </div>
            
            @if(legalLinks.hasTermsOfServiceUrl()) {
              <div class="form-group mb-3">
                <div class="form-check">
                  <input class="form-check-input @if(registerForm("agreeToTerms").hasErrors) {is-invalid}" type="checkbox" value="true" id="agreeToTerms" name="agreeToTerms" @if(registerForm("agreeToTerms").value.orElse("false").equals("true")) {checked}>
                  <label class="form-check-label" for="agreeToTerms">
                    <a href="@legalLinks.getTermsOfServiceUrl().get()" target="_blank">@messages("footer.terms")</a>に同意する
                  </label>
                  @if(registerForm("agreeToTerms").hasErrors) {
                    <div class="invalid-feedback">
                      @registerForm("agreeToTerms").errors.asScala.map(_.message).mkString(", ")
                    </div>
                  }
                </div>
              </div>
            }
            
            <button type="submit" class="btn btn-primary">@messages("auth.register.button")</button>
          }
          
          <div class="mt-3">
            <p>@messages("auth.have.account") <a href="@routes.AuthController.showLogin()">@messages("auth.login")</a></p>
          </div>
          
        </div>
      </div>
    </div>
  </div>

  <!-- Password strength validation -->
  <script src="@routes.Assets.versioned("lib/zxcvbn/dist/zxcvbn.js")"></script>
  <script>
    (function() {
      'use strict';
      
      const passwordInput = document.getElementById('password');
      const strengthContainer = document.getElementById('password-strength-container');
      const strengthBar = document.getElementById('password-strength-bar');
      const strengthText = document.getElementById('password-strength-text');
      const submitButton = document.querySelector('button[type="submit"]');
      
      if (!passwordInput || !strengthContainer) return;
      
      // Get localized strength labels from server
      const strengthLabels = {
        0: { text: '@messages("validation.password.strength.veryweak")', color: 'bg-danger', class: 'text-danger' },
        1: { text: '@messages("validation.password.strength.weak")', color: 'bg-warning', class: 'text-warning' },
        2: { text: '@messages("validation.password.strength.fair")', color: 'bg-info', class: 'text-info' },
        3: { text: '@messages("validation.password.strength.strong")', color: 'bg-success', class: 'text-success' },
        4: { text: '@messages("validation.password.strength.verystrong")', color: 'bg-success', class: 'text-success' }
      };
      
      const messages = {
        loading: '@Html(messages("validation.password.strength.loading").replace("'", "\\'"))',
        warning: '@Html(messages("validation.password.strength.warning").replace("'", "\\'"))',
        success: '@Html(messages("validation.password.strength.success").replace("'", "\\'"))',
        hint: '@Html(messages("validation.password.strength.hint").replace("'", "\\'"))'
      };
      
      function updatePasswordStrength() {
        const password = passwordInput.value;
        
        if (password.length === 0) {
          strengthContainer.style.display = 'none';
          return;
        }
        
        strengthContainer.style.display = 'block';
        
        if (typeof zxcvbn === 'undefined') {
          strengthText.textContent = messages.loading;
          return;
        }
        
        const result = zxcvbn(password);
        const score = result.score;
        const strength = strengthLabels[score];
        
        // Update progress bar
        strengthBar.className = 'progress-bar ' + strength.color;
        strengthBar.style.width = ((score + 1) * 20) + '%';
        
        // Update text
        strengthText.className = 'form-text ' + strength.class;
        
        if (score < 2) {
          strengthText.textContent = messages.warning.replace('{0}', strength.text);
          if (submitButton) {
            submitButton.disabled = true;
          }
        } else {
          strengthText.textContent = messages.success.replace('{0}', strength.text);
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
        
        // Show suggestions if available
        if (result.feedback && result.feedback.suggestions && result.feedback.suggestions.length > 0) {
          const suggestions = result.feedback.suggestions.join(' ');
          strengthText.textContent += messages.hint.replace('{0}', suggestions);
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        if (passwordInput.value) {
          updatePasswordStrength();
        }
      });
      
      // Update on input
      passwordInput.addEventListener('input', updatePasswordStrength);
      passwordInput.addEventListener('keyup', updatePasswordStrength);
    })();
  </script>

}
}